# vim: filetype=sh
# Bash functions sourced .bashrc

# There could be some aliases and env variables declared here in order to keep them closer
# to the code using them


# Generic Utility functions
function enabletouchpad {
  touchid=$(xinput list | grep 'Touchpad' | grep -P -o 'id=[0-9]+' | cut -d '=' -f 2)
  xinput set-prop $touchid "Device Enabled" 1
}

# SSH Agent configuration
# Included only for local profiles. Remote profiles will use ssh-agent forwarding
# File to store the SSH Agent environment
SSH_ENV=$HOME/.ssh/environment
# start the ssh-agent
function start_agent {
    echo "Initializing new SSH agent..."
    /usr/bin/ssh-agent | sed 's/^echo/#echo/' > "${SSH_ENV}"
    echo "Agent started...."

    # Source environment, which sets SSH_AGENT_PID in the current environment
    chmod 600 "${SSH_ENV}"
    . "${SSH_ENV}" > /dev/null

    # Adding keys to ssh agent
    find ~/.ssh -type f -name *.agent_add -exec /usr/bin/ssh-add {} \;
}
# Do not start SSH Agent if SSH agent is still running as the same PID
# as the one stored in the environment
if [ -f "${SSH_ENV}" ]; then
     . "${SSH_ENV}" > /dev/null
         ps -ef | grep ${SSH_AGENT_PID} | grep ssh-agent$ > /dev/null || {
            start_agent;
        }
else
    start_agent;
fi

# git functions
# git refresh remote branch list
function g-rrbl {
  git remote update origin --prune
}


# Docker functions
# System
function d-du {
  # Docker disk usage detail
  docker system df -v
}
function d-si {
  # show docker system information
  d-du
  docker system info
}
function d-sp {
  d-du
  docker system prune
}
# Container
function d-cl {
  docker container ls -a
}
function d-crm {
  docker container rm $(docker container ls -aq)
}
function d-cs {
  count=$(docker container ls | grep -c $1)
  [[ $count -eq 0 ]] && { echo "No docker containers match pattern"; return 1; }
  [[ $count -gt 1 ]] && { echo "More than 1 docker containers match pattern"; return 1; }
  c_label=$(docker container ls | grep "${1}" | cut -d " " -f 1)
  [[ -z "${c_label}" ]] && { echo "Container pattern matching failed"; return 1; }
  docker container stop "${c_label}"
}
# Image
function d-il {
  docker image ls $1 | sort -k 7 -h
}
# Volume
function d-vl {
  docker volume ls
}
function d-vi {
  count=$(docker volume ls | grep -c $1)
  [[ $count -eq 0 ]] && { echo "No docker volumes match pattern"; return 1; }
  [[ $count -gt 1 ]] && { echo "More than 1 docker volumes match pattern"; return 1; }
  vol_label=$(docker volume ls | grep "${1}" | cut -d " " -f 16)
  [[ -z "${vol_label}" ]] && { echo "Volumes pattern matching failed"; return 1; }
  docker volume inspect "${vol_label}"
}
function d-vpr {
  docker volume prune
}

